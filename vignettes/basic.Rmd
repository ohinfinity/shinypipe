---
title: "shinypipe vignette"
author: "Karthik Rajendran"
date: "December, 2017"
output: 
  html_document:
    toc : true
    toc_float : true
    code_folding: hide
runtime: shiny
---

```{r Library, include=F}
rm(list = ls())
library(datasets)
library(data.table)
library(ggplot2)

runWithoutInstall <- T
ifelse(runWithoutInstall,
       sapply(list.files(path = "../R/", pattern="*R", full.names = T), source),
       library(shinypipe))

data(mtcars)
rv <- reactiveValues(table=as.data.table(mtcars))
rm(mtcars)
```

### File upload 1

You can override the default selected values of *sep* and *header*

```{r }
ui.fread("file1")
r.data1 <- callModule(s.fread, "file1")
renderTable(head(r.data1()))
```

### File upload 2

Here, the user is not given the choice to select separator (by setting sep = NULL).
Instead, we can specify *sep* directly in the server function. 
The same may be achieved for header argument as well.
```{r }
ui.fread("file2", sep = NULL)
r.data2 <- callModule(s.fread, "file2", params = list(sep = ","))
renderTable(head(r.data2()))
```

#### Table used in the rest of the vignette

We will either use the preloaded table or whichever table was uploaded the latest from the file upload widgets above.
```{r}
r.data <- reactive(as.data.table(rv$table))
observe(rv$table <- r.data1())
observe(rv$table <- r.data2())
renderTable(head(r.data()))
```

### Simple Formula editor

Formulas can be dynamically constructed using column names of the tables. Here, we will restrict the user to one explanatory variable by setting the parameter simpleFormula to TRUE.

```{r}
renderUI({
  cols <- list(choices = names(r.data())[1:5])
  ui.formula("form", cols, cols, simpleFormula = T, theme = "small")
})
```

#### Output formula

```{r}
r.form <- callModule(s.formula, "form")
renderPrint(r.form())
```


### Plot widget (formula usage)

```{r}

r.yVal <- callModule(s.formula.y, "form")
r.xVal <- callModule(s.formula.x, "form")

ui.plot("plot")
r.plot <- reactive(geom_point(aes_string(x=r.xVal(), y=r.yVal())))
r.brushedData <- callModule(s.plot, "plot", r.plot, r.data, selected.colname = "selected")

```

#### Selected Data

```{r}
renderDataTable(r.brushedData())
```


### Formula editor: example 1

Formulas can be dynamically constructed using column names of the tables

```{r}
renderUI({
  cols <- list(choices = names(r.data()))
  ui.formula("fml", cols, cols, T)
})
```

#### Output formula

```{r}
r.fml <- callModule(s.formula, "fml")
renderPrint(r.fml())
```

The choice of whether to include intercept or not can be hidden from the user by leaving 
the intercept to its default value of NULL as shown in the "Simple formula editor" example.

### Formula editor: example 2

Perform a simple regression using the formula

```{r}
renderPrint(summary(lm(r.fml(), r.data())))
```

### Using params: example 1

Fit a generalized linear model

```{r}
ui.params("params",
          family  = list("", c("gaussian", "poisson")))
r.glmParams <- callModule(s.params, "params")

renderPrint({
  f <- do.call(stats::glm, c(list(formula = r.fml(), data = r.data()), r.glmParams()))
  f$coefficients
})

```

### Using params: example 2

```{r}
ui.params("paramList",
          name  = list("", NA, placeholder = "Enter your name here", width = '100%'),
          dob   = list(Sys.Date(), NA, label = "Date of birth"))
r.paramList <- callModule(s.params, "paramList")

my.f <- function(name, dob) {
  age <- (Sys.Date() - dob)
  if (is.null(name) || name == "") return ("Enter your name above.");
  if (age <= 0) return ("Enter a valid date");
  return (paste0("You're ", age, " day(s) old, ", name, "."))
} 

renderPrint(do.call(my.f, r.paramList()))
```



