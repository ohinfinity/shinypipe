---
title: "shinypipe vignette"
author: "Karthik Rajendran"
output: 
  html_document:
    toc : true
    toc_float : true
    code_folding: hide
runtime: shiny
---

```{r Library, include=F}
rm(list = ls())
library(datasets)
library(data.table)
library(ggplot2)

runWithoutInstall <- T
ifelse(runWithoutInstall,
       sapply(list.files(path = "../R/", pattern="*R", full.names = T), source),
       library(shinypipe))

data(mtcars)
rv <- reactiveValues(table=as.data.table(mtcars))
rm(mtcars)
```

### File upload 1

You can override the default selected values of *sep* and *header*

```{r }
ui.fread("file1")
r.data1 <- callModule(s.fread, "file1")
renderTable(head(r.data1()))
```

### File upload 2

Here, the user is not given the choice to select separator (by setting sep = NULL).
Instead, we can specify *sep* directly in the server function. 
The same may be achieved for header argument as well.
```{r }
ui.fread("file2", sep = NULL)
r.data2 <- callModule(s.fread, "file2", params = list(sep = ","))
renderTable(head(r.data2()))
```

#### Table used in the rest of the vignette

We will either use the preloaded table or whichever table was uploaded the latest from the file upload widgets above.
```{r}
r.data <- reactive(as.data.table(rv$table))
observe(rv$table <- r.data1())
observe(rv$table <- r.data2())
renderTable(head(r.data()))
```

### Simple Formula editor

Formulas can be dynamically constructed using column names of the tables. Here, we will restrict the user to one explanatory variable by setting the parameter simpleFormula to TRUE.

```{r}
renderUI({
  colsY <- list(choices = names(r.data())[1:5])
  colsX <- list(choices = names(r.data())[-(1:5)])
  ui.formula("form", colsY, colsX, simpleFormula = T, theme = "small")
})
```

#### Output formula

```{r}
r.form <- callModule(s.formula, "form")
renderPrint(r.form())
```

### Plot widget (formula usage)

```{r}

r.yVal <- callModule(s.formula.y, "form")
r.xVal <- callModule(s.formula.x, "form")

ui.plot("plot")
r.plot <- reactive(geom_point(aes_string(x=r.xVal(), y=r.yVal())))
r.brushedData <- callModule(s.plot, "plot", r.plot, r.data, selected.colname = "selected")

```

#### Selected Data

Show head of the selected data from the plot below:

```{r}
renderDataTable(head(r.brushedData()[selected==T]))
```


### Formula editor: example 1

Formulas can be dynamically constructed using column names of the tables

```{r}
renderUI({
  colsY <- list(choices = names(r.data()))
  colsX <- list(choices = names(r.data()), selected = "wt")
  ui.formula("fml", colsY, colsX, T)
})
```

#### Output formula

```{r}
r.fml <- callModule(s.formula, "fml")
r.fml.y <- callModule(s.formula.y, "fml")
renderPrint(r.fml())
```

The choice of whether to include intercept or not can be hidden from the user by leaving 
the intercept to its default value of NULL as shown in the "Simple formula editor" example.

### Linear regression (Full table)

```{r}
renderPrint(summary(lm(r.fml(), r.data())))
```

### Linear regression (Selected)

```{r}
renderPrint({
  dt <- r.brushedData()[selected==T]
  if (dt[,.N] == 0)
    return("Brush the points on the graph above to select portion of the dataset")
  summary(lm(r.fml(), dt))
})
```

### Using params: SVM example

Run SVM. Note: note all parameters are applicable for all kernels.

```{r}
library(e1071)
ui.params("params",
          kernel  = list("linear", c("linear", "polynomial", "radial", "sigmoid")),
          cost    = list(1, c(1,10)),
          gamma   = list(1, c(0,1), step = .01),
          coef0   = list(0, c(0,1), step = .01),
          degree  = list(3, c(2,5)))
r.svmParams <- callModule(s.params, "params")

r.svmModel <- reactive(do.call(svm, c(list(formula = r.fml(), data = r.data()), r.svmParams())))

renderPrint({f <- r.svmModel(); f$call <- NULL; return(summary(f));})
```


#### RMS error
```{r}
renderPrint(sqrt(mean((predict(r.svmModel()) - r.data()[,r.fml.y(), with=F])^2)))
```

### Using params: Example 2

```{r}
ui.params("paramList",
          name  = list("", NA, placeholder = "Enter your name here", width = '100%'),
          dob   = list(Sys.Date()-1, NA, label = "Date of birth"))
r.paramList <- callModule(s.params, "paramList")

my.f <- function(name, dob) {
  age <- (Sys.Date() - dob)
  if (is.null(name) || name == "") return ("Enter your name above.");
  if (age <= 0) return ("Enter a valid date");
  return (paste0("You're ", age, " day(s) old, ", name, "."))
} 

renderPrint(do.call(my.f, r.paramList()))
```

